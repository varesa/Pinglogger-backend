#!/bin/env bash
# pingloggerctl
#
# Controls instances of pinglogger-scripts

###############################
# Source config and variables #
###############################

source /var/www/html/grapher/pinglogger/conf/global.conf

#########################
# Functions declaration #
#########################

start() {
    if [ -z $1 ]; then
	echo "Please provide a name of config to be started"
	return
    elif [ ! -e $BaseDir/$ConfDir/$1 ]; then
	echo "Config with name \"$1\" does not exist"
	return
    elif [ -e $BaseDir/$PidDir/$1.pid ]; then
	echo "Logger with config \"$1\" is already running"
	return
    fi

    echo "Starting $1"
    nohup ./pinglogger $BaseDir/conf/global.conf $1 > /dev/null 2>&1 &
}

stop() {
    if [ -z $1 ]; then
	echo "Please provide a name of config to be stopped"
	return
    elif [ ! -e $BaseDir/$ConfDir/$1 ]; then
	echo "Config with name \"$1\" does not exist"
	return
    elif [ ! -e $BaseDir/$PidDir/$1.pid ]; then
	echo "Logger with config \"$1\" is not running"
	return
    fi

    pid=$(cat $BaseDir/$PidDir/$1.pid)
    if [[ ! "$(ps -A | grep $pid)" ]]; then
	echo "Pid-file exists, but can't find the process, removing pid-file"
	rm $BaseDir/$PidDir/$1.pid
	return
    fi
    
    echo "Stopping $1"
    kill $pid
}

list() {
    for inst in $BaseDir/$ConfDir/*
    do
        name=$(echo $inst | sed -r "s|$BaseDir/$ConfDir/(.*)|\1|g")
        if [ -e $BaseDir/$PidDir/$name.pid ]; then
	    pid=$(cat $BaseDir/$PidDir/$name.pid)
	    if [[ "$(ps -A | grep $pid)" ]]; then
		state="running"
	    else
		state="dead, pidfile present, removing"
		rm $BaseDir/$PidDir/$name.pid
	    fi
	else
	    state="not running"
	fi
    done
    echo $name: $state
}

startall() {
    echo "startall"
}

stopall() {
    echo "stopall"
}

usage() {
    echo "pingloggerctl start|stop|list|startall|stopall [instance]"
}

############################
# Startpoint - handle args #
############################

case $1 in
    start) start $2
           ;;

    stop)  stop $2
           ;;

    list)  list
           ;;

    startall) startall
              ;;

    stopall)  stopall
              ;;

    *)   usage
         ;;
esac